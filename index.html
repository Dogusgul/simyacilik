<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Simya D√ºkkanƒ±</title>
<style>
  body {
    font-family: Arial, sans-serif;
    text-align: center;
    background-color: #f0f0f0;
    margin: 0;
    padding: 20px;
    color: #333;
  }
  .game-container {
    max-width: 1200px;
    margin: 0 auto;
    background: #fff;
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    padding: 20px;
  }
  h1, h2 {
    color: #2c3e50;
    margin-top: 0; /* √ústteki gereksiz bo≈üluƒüu kaldƒ±r */
    margin-bottom: 10px;
  }
  button {
    background-color: #3498db;
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 16px;
    margin: 5px;
    transition: background-color 0.2s;
  }
  button:hover {
    background-color: #2980b9;
  }
  button:disabled {
    background-color: #bdc3c7;
    cursor: not-allowed;
  }
  .info-bar {
    background-color: #ecf0f1;
    padding: 10px;
    border-radius: 8px;
    margin-bottom: 20px;
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
  }
  #money, #level-info {
    font-size: 20px;
    color: #2c3e50;
    margin: 5px 0;
    user-select: none;
  }
  #xp-bar-container {
    width: 100%;
    background-color: #bdc3c7;
    border-radius: 10px;
    height: 22px; /* Y√ºksekliƒüi biraz artƒ±rdƒ±k */
    margin-top: 5px;
    position: relative;
    overflow: hidden; /* Ta≈üan kƒ±sƒ±mlarƒ± gizle */
  }
  #xp-bar {
    width: 0%;
    height: 100%;
    background-color: #2ecc71;
    border-radius: 10px;
    transition: width 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    color: white;
    /* D√úZELTME: Yazƒ±nƒ±n ta≈ümasƒ±nƒ± engellemek i√ßin */
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    padding: 0 5px; /* Yazƒ± kenarlara yapƒ±≈ümasƒ±n */
  }

  .materials-header {
    margin-top: 20px;
    font-size: 18px;
    color: #7f8c8d;
  }
  .materials-grid {
    margin: 10px 0 20px;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); /* Min geni≈üliƒüi artƒ±rdƒ±k */
    gap: 15px;
    justify-items: center;
  }
  .material-item {
    font-size: 14px; /* Yazƒ± tipini biraz k√º√ß√ºltt√ºk */
    cursor: pointer;
    padding: 8px; /* Padding ayarlandƒ± */
    background-color: #f1c40f;
    border-radius: 10px;
    transition: transform 0.2s, box-shadow 0.2s;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: space-around; /* ƒ∞√ßeriƒüi dikeyde yay */
    width: 110px; /* Geni≈ülik g√ºncellendi */
    height: 110px; /* Y√ºkseklik g√ºncellendi */
    text-align: center;
    box-sizing: border-box;
    user-select: none;
    color: #333;
    border: 2px solid #e67e22;
    overflow: hidden; /* Ta≈üan metni gizle */
  }
  .material-item div:first-child { /* Emoji */
    font-size: 32px; 
    margin-bottom: 3px;
  }
  .material-item div:last-child { /* ƒ∞sim ve Fiyat */
    font-size: 13px; /* Yazƒ± boyutu ayarlandƒ± */
    line-height: 1.2; /* Satƒ±r y√ºksekliƒüi */
    word-break: break-word; /* Gerekirse kelimeyi b√∂l */
  }
  .material-item:hover {
    transform: translateY(-5px);
    box-shadow: 0 6px 12px rgba(0,0,0,0.1);
  }

  .cauldron-section {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-bottom: 20px;
  }
  .cauldron {
    background-color: #34495e;
    border-radius: 50%;
    width: 180px;
    height: 180px;
    border: 6px solid #f39c12;
    color: white;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    box-shadow: 0 0 15px rgba(0,0,0,0.3) inset;
  }
  .cauldron h2 {
    margin: 0 0 8px;
    font-size: 20px;
  }
  .cauldron-content {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    max-width: 140px;
  }
  .cauldron-content div {
    font-size: 36px;
    margin: 2px;
    user-select: none;
  }
  #boil-btn {
    background-color: #e74c3c;
    margin-top: 15px;
  }
  #boil-btn:hover {
    background-color: #c0392b;
  }

  .inventory-section, .material-inventory-section {
    background-color: #ecf0f1;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
    min-height: 60px;
  }
  .inventory-section h2, .material-inventory-section h2 {
    margin: 0 0 10px;
    color: #2c3e50;
  }
  .inventory-item, .material-inv-item {
    background-color: #2ecc71;
    padding: 6px 12px;
    border-radius: 5px;
    color: white;
    margin: 4px;
    display: inline-block;
    user-select: none;
    font-size: 14px;
  }
  .material-inv-item {
    background-color: #f39c12;
    color: #333;
  }

  #error-message {
    background-color: #e74c3c;
    color: white;
    padding: 10px;
    font-size: 16px;
    margin: 0 auto 15px;
    max-width: 400px;
    border-radius: 6px;
    display: none;
    user-select: none;
  }
  
  .customer-area {
    min-height: 220px; /* M√º≈üteri ve balonu i√ßin yeterli alan */
    display: flex;
    align-items: flex-end; /* M√º≈üteriyi a≈üaƒüƒ±ya yasla ki balona yer kalsƒ±n */
    justify-content: center;
    padding-bottom: 20px; /* Alt bo≈üluk */
    position: relative; /* Konu≈üma balonunun buna g√∂re konumlanmasƒ± i√ßin */
  }
  .customer {
    cursor: pointer;
    display: inline-block;
    font-size: 70px;
    user-select: none;
    padding: 10px;
    transition: transform 0.2s;
    position: relative; /* Konu≈üma balonunun m√º≈üteriye g√∂re konumlanmasƒ± i√ßin */
  }
  .customer:hover {
      transform: scale(1.1);
  }
  .speech-bubble {
    position: absolute;
    bottom: 100%; /* M√º≈üterinin hemen √ºst√ºnde */
    left: 50%;
    transform: translateX(-50%) translateY(-10px); /* Biraz yukarƒ± ve ortala */
    background-color: #3498db;
    padding: 8px 12px;
    border-radius: 8px;
    color: white;
    font-size: 14px;
    min-width: 150px; 
    max-width: 220px;
    white-space: normal;
    word-wrap: break-word;
    line-height: 1.3;
    box-sizing: border-box;
    z-index: 10;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  }
  .speech-bubble.story {
      bottom: calc(100% + 50px); /* Hikaye balonu i√ßin daha yukarƒ±da */
      background-color: #9b59b6; 
  }

  .modal {
    display: none;
    position: fixed;
    z-index: 100;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.5);
    align-items: center;
    justify-content: center;
  }
  .modal-content {
    background-color: #fefefe;
    margin: auto;
    padding: 20px;
    border: 1px solid #888;
    width: 80%;
    max-width: 500px;
    border-radius: 10px;
    text-align: left;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
  }
  .modal-content h2 { text-align: center; }
  .close-btn {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
  }
  .recipe-item, .upgrade-item, .achievement-item {
    font-size: 16px;
    margin: 8px 0;
    padding: 8px;
    background-color: #f9f9f9;
    border-radius: 4px;
    border-left: 4px solid #3498db;
  }
  .upgrade-item button { margin-left: 10px; padding: 5px 10px; font-size: 14px;}
  .achievement-item.completed {
    border-left-color: #2ecc71;
    text-decoration: line-through;
    color: #7f8c8d;
  }
  .achievement-reward { font-style: italic; font-size: 0.9em; color: #27ae60;}

  .tabs { margin-bottom: 15px; display: flex; justify-content: center; }
  .tab-button { background-color: #7f8c8d; margin: 0 5px; }
  .tab-button.active { background-color: #2980b9; }

  #buy-material-modal .material-buy-option {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      border-bottom: 1px solid #eee;
  }
   #buy-material-modal .material-buy-option:last-child { border-bottom: none;}
   #buy-material-modal .material-emoji { font-size: 24px; margin-right: 10px;}
   #buy-material-modal input[type="number"] { width: 60px; padding: 5px; margin-left: 10px; margin-right: 10px;}
</style>
</head>
<body>
  <div class="game-container">
    <h1>Simya D√ºkkanƒ±</h1>

    <div class="info-bar">
      <div id="money">Para: 250 TL</div>
      <div id="level-info">Seviye: 1</div>
      <div id="xp-bar-container">
        <div id="xp-bar">0/100 XP</div>
      </div>
    </div>
    <div id="error-message">Bu tarif i≈üe yaramaz!</div>
    
    <div class="tabs">
        <button id="recipe-button" class="tab-button" onclick="showModal('recipe-modal')">ƒ∞ksir Tarifleri</button>
        <button id="upgrades-button" class="tab-button" onclick="showModal('upgrades-modal')">D√ºkkan Geli≈ütirmeleri</button>
        <button id="achievements-button" class="tab-button" onclick="showModal('achievements-modal')">Ba≈üarƒ±mlar</button>
    </div>

    <div class="material-inventory-section">
        <h2>Malzemelerim</h2>
        <div id="material-inventory-content">Malzeme yok.</div>
    </div>

    <div class="materials-header">Satƒ±n Alƒ±nabilir Malzemeler</div>
    <div class="materials-grid">
      <div class="material-item" data-name="Uƒüur B√∂ceƒüi" data-price="15"><div>üêû</div><div>Uƒüur B√∂ceƒüi (15TL)</div></div>
      <div class="material-item" data-name="√ái√ßek" data-price="10"><div>üå∏</div><div>√ái√ßek (10TL)</div></div>
      <div class="material-item" data-name="Karƒ±nca" data-price="20"><div>üêú</div><div>Karƒ±nca (20TL)</div></div>
      <div class="material-item" data-name="B√ºy√ºl√º Ta≈ü" data-price="50"><div>üîÆ</div><div>B√ºy√ºl√º Ta≈ü (50TL)</div></div>
      <div class="material-item" data-name="Su Damlasƒ±" data-price="5"><div>üíß</div><div>Su Damlasƒ± (5TL)</div></div>
      <div class="material-item" data-name="Ate≈ü" data-price="25"><div>üî•</div><div>Ate≈ü (25TL)</div></div>
      <div class="material-item" data-name="Yƒ±lan" data-price="40"><div>üêç</div><div>Yƒ±lan (40TL)</div></div>
      <div class="material-item" data-name="B√ºy√ºl√º Toz" data-price="60"><div>‚ú®</div><div>B√ºy√ºl√º Toz (60TL)</div></div>
      <div class="material-item" data-name="Ay I≈üƒ±ƒüƒ±" data-price="45"><div>üåô</div><div>Ay I≈üƒ±ƒüƒ± (45TL)</div></div>
      <div class="material-item" data-name="Zehirli Mantar" data-price="30"><div>üçÑ</div><div>Zehirli Mantar (30TL)</div></div>
    </div>

    <div class="cauldron-section">
      <div class="cauldron">
        <h2>Kazan</h2>
        <div id="cauldron-content">Malzeme se√ß...</div>
      </div>
      <button id="boil-btn" onclick="boilIngredients()">Kaynat</button>
    </div>

    <div class="inventory-section">
      <h2>ƒ∞ksir Envanteri</h2>
      <div id="inventory-content">ƒ∞ksir yok.</div>
    </div>
    
    <div class="customer-area">
        <div id="customers"></div>
    </div>
  </div>

  <div id="recipe-modal" class="modal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeModal('recipe-modal')">&times;</span>
      <h2>ƒ∞ksir Tarifleri</h2>
      <div id="recipe-list">
        <div class="recipe-item"><span>Saƒülƒ±k ƒ∞ksiri:</span> üêû + üå∏</div>
        <div class="recipe-item"><span>Hƒ±z ƒ∞ksiri:</span> üêú + üå∏</div>
        <div class="recipe-item"><span>G√º√ß ƒ∞ksiri:</span> üêû + üêú</div>
        <div class="recipe-item"><span>B√ºy√º ƒ∞ksiri:</span> üîÆ + üå∏</div>
        <div class="recipe-item"><span>Ate≈ü ƒ∞ksiri:</span> üî• + üêû</div>
        <div class="recipe-item"><span>Su ƒ∞ksiri:</span> üíß + üêú</div>
        <div class="recipe-item"><span>Yƒ±lan ƒ∞ksiri:</span> üêç + ‚ú®</div>
        <div class="recipe-item"><span>Ay I≈üƒ±ƒüƒ± ƒ∞ksiri:</span> üåô + üîÆ</div>
        <div class="recipe-item"><span>Zehir ƒ∞ksiri:</span> üçÑ + üîÆ</div>
        <div class="recipe-item"><span>Buz ƒ∞ksiri:</span> üçÑ + üíß</div>
        <div class="recipe-item"><span>Zenginlik ƒ∞ksiri:</span> ‚ú® + üçÑ</div>
        <div class="recipe-item"><span>Zihin G√ºc√º ƒ∞ksiri:</span> üåô + ‚ú®</div>
        <div class="recipe-item"><span>Enerji ƒ∞ksiri:</span> üî• + üçÑ</div>
      </div>
    </div>
  </div>

  <div id="upgrades-modal" class="modal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeModal('upgrades-modal')">&times;</span>
      <h2>D√ºkkan Geli≈ütirmeleri</h2>
      <div id="upgrades-list"></div>
    </div>
  </div>

  <div id="achievements-modal" class="modal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeModal('achievements-modal')">&times;</span>
      <h2>Ba≈üarƒ±mlar</h2>
      <div id="achievements-list"></div>
    </div>
  </div>
  
  <div id="buy-material-modal" class="modal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeModal('buy-material-modal')">&times;</span>
      <h2 id="buy-material-name">Malzeme Satƒ±n Al</h2>
      <div class="material-buy-option">
          <span id="buy-material-info"></span>
          <input type="number" id="buy-material-amount" value="1" min="1">
          <button id="confirm-buy-material-btn">Satƒ±n Al</button>
      </div>
      <p>Mevcut Bakiye: <span id="buy-modal-money"></span> TL</p>
    </div>
  </div>

  <audio id="sound-add-material" src="sounds/add_material.wav"></audio>
  <audio id="sound-boil" src="sounds/boil_potion.wav"></audio>
  <audio id="sound-customer-appears" src="sounds/customer_bell.wav"></audio>
  <audio id="sound-sell-potion" src="sounds/sell_potion.wav"></audio>
  <audio id="sound-error" src="sounds/error_buzz.wav"></audio>
  <audio id="sound-level-up" src="sounds/level_up.wav"></audio>
  <audio id="sound-achievement" src="sounds/achievement_unlocked.wav"></audio>
  <audio id="sound-upgrade" src="sounds/upgrade_shop.wav"></audio>
  <audio id="sound-buy-material" src="sounds/buy_item.wav"></audio>

  <script>
    const availableEmojis = ['üë©üèª', 'üë®üèΩ', 'üë©üèø‚Äçü¶±', 'üë®üèº', 'üëµüèª', 'üë¥üèΩ', 'üßëüèª', 'üßëüèº', 'üßëüèΩ', 'üë©üèΩ', 'üë®üèª'];
    const availablePotions = [
      'Saƒülƒ±k ƒ∞ksiri', 'Hƒ±z ƒ∞ksiri', 'G√º√ß ƒ∞ksiri', 'B√ºy√º ƒ∞ksiri', 'Ate≈ü ƒ∞ksiri', 'Su ƒ∞ksiri',
      'Yƒ±lan ƒ∞ksiri', 'Ay I≈üƒ±ƒüƒ± ƒ∞ksiri', 'Zehir ƒ∞ksiri', 'Buz ƒ∞ksiri', 'Zenginlik ƒ∞ksiri',
      'Zihin G√ºc√º ƒ∞ksiri', 'Enerji ƒ∞ksiri'
    ];

    const stories = {
      'Saƒülƒ±k ƒ∞ksiri': [
        "Sonunda saƒülƒ±ƒüƒ±ma kavu≈üacaƒüƒ±m! O kadar uzun zamandƒ±r hastaydƒ±m ki, bir yudum Saƒülƒ±k ƒ∞ksiri her ≈üeyi deƒüi≈ütirecek!",
        "Gece boyunca uyumadƒ±m, bedenim yorgun. Saƒülƒ±k ƒ∞ksiri bana yeniden g√º√ß verebilir mi?"
      ],
      'Hƒ±z ƒ∞ksiri': [
        "√áok acelem var! Hƒ±zlƒ±ca g√∂revimi tamamlamak zorundayƒ±m, belki bu iksir bana yardƒ±mcƒ± olur.",
        "Yava≈ü olmak zorunda deƒüilim! Hƒ±z ƒ∞ksiriyle hƒ±zlƒ±ca gitmem gereken yere ula≈üacaƒüƒ±m."
      ],
      'G√º√ß ƒ∞ksiri': [
        "Fiziksel g√ºc√ºm√º artƒ±rmam gerekiyor, bir m√ºcadeleye hazƒ±rlƒ±k yapƒ±yorum ve bu iksir bana b√ºy√ºk bir avantaj saƒülar.",
        "Yƒ±llardƒ±r g√º√ßs√ºz hissediyorum, bir miktar g√º√ß kazanmak artƒ±k elzem oldu."
      ],
      'B√ºy√º ƒ∞ksiri': [
        "B√ºy√º yapmak istiyorum, ama g√ºc√ºm yetmiyor! Bu iksir beni b√ºy√º yeteneklerimi geli≈ütirebilir.",
        "Bir b√ºy√ºc√º olmayƒ± hep hayal ettim. Belki bu iksirle o hayalim ger√ßek olur."
      ],
      'Ate≈ü ƒ∞ksiri': [
        "Bazen ate≈ü, ruhumu ƒ±sƒ±tacak tek ≈üey oluyor. Biraz da cesaret isterim, bu iksir bana yardƒ±mcƒ± olabilir.",
        "Bunu almak zorundayƒ±m! Ate≈üin g√ºc√ºn√º hissetmek ve √ßevremdeki d√ºnyayƒ± aydƒ±nlatmak istiyorum."
      ],
       'Zihin G√ºc√º ƒ∞ksiri': [
        "Zihinsel engellerim var, bu iksirle d√º≈ü√ºnme kapasitemi artƒ±rƒ±p sorunlarƒ± √ß√∂zmeyi umuyorum.",
        "Bazen zihnim √ßok daƒüƒ±lmƒ±≈ü hissediyorum, bu iksir bana netlik ve odaklanma saƒülayacak."
      ],
      'Zehir ƒ∞ksiri': [
        "Zehir, √ßok g√º√ßl√º bir silah olabilir... ama sadece doƒüru ≈üekilde kullanƒ±ldƒ±ƒüƒ±nda. Bu iksir, d√º≈ümanlarƒ±mƒ± etkisiz hale getirebilir.",
        "Bazen bazƒ± ≈üeyleri yok etmem gerek, bu zehir iksiriyle her ≈üeyi temizleyeceƒüim."
      ],
      'Buz ƒ∞ksiri': [
        "Bazen soƒüukkanlƒ±lƒ±k her ≈üeydir, bu Buz ƒ∞ksiri sayesinde zor anlarƒ± daha kolay atlatabilirim.",
        "Sƒ±cak bir ortamda √ßok zorlandƒ±m, bu iksirle biraz serinlik bulabilirim."
      ]
    };

    const materialData = {
        'Uƒüur B√∂ceƒüi': { emoji: 'üêû', price: 15 }, '√ái√ßek': { emoji: 'üå∏', price: 10 },
        'Karƒ±nca': { emoji: 'üêú', price: 20 }, 'B√ºy√ºl√º Ta≈ü': { emoji: 'üîÆ', price: 50 },
        'Su Damlasƒ±': { emoji: 'üíß', price: 5 }, 'Ate≈ü': { emoji: 'üî•', price: 25 },
        'Yƒ±lan': { emoji: 'üêç', price: 40 }, 'B√ºy√ºl√º Toz': { emoji: '‚ú®', price: 60 },
        'Ay I≈üƒ±ƒüƒ±': { emoji: 'üåô', price: 45 }, 'Zehirli Mantar': { emoji: 'üçÑ', price: 30 }
    };

    const recipes = {
        '√ái√ßek,Uƒüur B√∂ceƒüi': { name: 'Saƒülƒ±k ƒ∞ksiri', xp: 10, price: 50 },
        '√ái√ßek,Karƒ±nca': { name: 'Hƒ±z ƒ∞ksiri', xp: 12, price: 60 },
        'Karƒ±nca,Uƒüur B√∂ceƒüi': { name: 'G√º√ß ƒ∞ksiri', xp: 15, price: 70 },
        'B√ºy√ºl√º Ta≈ü,√ái√ßek': { name: 'B√ºy√º ƒ∞ksiri', xp: 20, price: 100 },
        'Ate≈ü,Uƒüur B√∂ceƒüi': { name: 'Ate≈ü ƒ∞ksiri', xp: 18, price: 90 },
        'Karƒ±nca,Su Damlasƒ±': { name: 'Su ƒ∞ksiri', xp: 8, price: 40 },
        'B√ºy√ºl√º Toz,Yƒ±lan': { name: 'Yƒ±lan ƒ∞ksiri', xp: 25, price: 120 },
        'Ay I≈üƒ±ƒüƒ±,B√ºy√ºl√º Ta≈ü': { name: 'Ay I≈üƒ±ƒüƒ± ƒ∞ksiri', xp: 22, price: 110 },
        'B√ºy√ºl√º Ta≈ü,Zehirli Mantar': { name: 'Zehir ƒ∞ksiri', xp: 18, price: 85 },
        'Su Damlasƒ±,Zehirli Mantar': { name: 'Buz ƒ∞ksiri', xp: 16, price: 75 },
        'B√ºy√ºl√º Toz,Zehirli Mantar': { name: 'Zenginlik ƒ∞ksiri', xp: 30, price: 150 },
        'Ay I≈üƒ±ƒüƒ±,B√ºy√ºl√º Toz': { name: 'Zihin G√ºc√º ƒ∞ksiri', xp: 28, price: 140 },
        'Ate≈ü,Zehirli Mantar': { name: 'Enerji ƒ∞ksiri', xp: 20, price: 95 }
    };
    
    const upgrades = {
        biggerCauldron: { name: "Geni≈ü Kazan", description: "Aynƒ± anda 3 malzeme ile iksir yap (yeni tarifler gerektirir).", cost: 500, purchased: false, effect: () => cauldronCapacity = 3 },
        bargainSkills: { name: "Pazarlƒ±k Becerisi", description: "ƒ∞ksir satƒ±≈ü fiyatlarƒ±nƒ± %20 artƒ±r.", cost: 1000, purchased: false, effect: () => potionSaleMultiplier = 1.2 },
        alchemyKnowledge: { name: "Simya Bilgisi", description: "ƒ∞ksir yapƒ±mƒ±ndan %50 daha fazla XP kazan.", cost: 750, purchased: false, effect: () => xpGainMultiplier = 1.5 }
    };

    const achievements = {
        firstPotion: { name: "Acemi Simyacƒ±", description: "ƒ∞lk iksirini yap.", completed: false, reward: { money: 50, xp: 20 } },
        tenRecipes: { name: "Kalfa Simyacƒ±", description: "5 farklƒ± tarifle iksir yap.", completed: false, reward: { money: 100, xp: 50 } },
        allRecipes: { name: "Usta Simyacƒ±", description: "T√ºm tarifleri ke≈üfet.", completed: false, reward: { money: 500, xp: 200 } },
        richAlchemist: { name: "Giri≈üimci Ruh", description: "Toplam 1000 TL kazan.", completed: false, reward: { money: 0, xp: 100 } },
        potionMaster: { name: "ƒ∞ksir Uzmanƒ±", description: "Toplam 50 iksir yap.", completed: false, reward: { money: 200, xp: 100 } }
    };

    let cauldronContents = [];
    let potionInventory = {};
    let materialInventory = {};
    let money = 250;
    let currentCustomerPotion = null;
    let level = 1;
    let xp = 0;
    let xpToNextLevel = 100;
    let cauldronCapacity = 2;
    let potionSaleMultiplier = 1.0;
    let xpGainMultiplier = 1.0;
    let madeRecipeCount = 0;
    let totalPotionsMade = 0;
    let discoveredRecipes = new Set();


    function playSound(soundId) {
      const sound = document.getElementById(soundId);
      if(sound && sound.readyState >= 2){ 
        sound.currentTime = 0;
        sound.play().catch(e => console.warn("Ses √ßalma hatasƒ±:", e));
      }
    }

    function openBuyMaterialModal(materialName) {
        const material = materialData[materialName];
        document.getElementById('buy-material-name').textContent = `${materialName} Satƒ±n Al`;
        document.getElementById('buy-material-info').innerHTML = `<span class="material-emoji">${material.emoji}</span> Tane Fiyatƒ±: ${material.price} TL`;
        document.getElementById('buy-modal-money').textContent = money;
        document.getElementById('buy-material-amount').value = 1;
        document.getElementById('buy-material-amount').max = Math.floor(money / material.price) || 1; // Maksimum alƒ±nabilecek miktar
        
        const confirmBtn = document.getElementById('confirm-buy-material-btn');
        confirmBtn.onclick = () => confirmBuyMaterial(materialName, material.price);
        
        showModal('buy-material-modal');
    }

    function confirmBuyMaterial(materialName, pricePerUnit) {
        const amountInput = document.getElementById('buy-material-amount');
        const amount = parseInt(amountInput.value);
        
        if (isNaN(amount) || amount <= 0) {
            alert("L√ºtfen ge√ßerli bir miktar girin.");
            return;
        }
        const totalCost = amount * pricePerUnit;

        if (money >= totalCost) {
            money -= totalCost;
            materialInventory[materialName] = (materialInventory[materialName] || 0) + amount;
            updateMoneyDisplay();
            updateMaterialInventoryDisplay();
            playSound('sound-buy-material');
            closeModal('buy-material-modal');
            saveGameData();
        } else {
            alert("Yeterli paranƒ±z yok!");
        }
    }
    
    function addToCauldron(materialName) {
      if (!materialInventory[materialName] || materialInventory[materialName] <= 0) {
        alert(`${materialName} envanterinizde yok! √ñnce satƒ±n almalƒ±sƒ±nƒ±z.`);
        return;
      }
      if (cauldronContents.length >= cauldronCapacity) {
          alert(`Kazan dolu! En fazla ${cauldronCapacity} malzeme ekleyebilirsiniz.`);
          return;
      }
      
      cauldronContents.push(materialName);
      materialInventory[materialName]--;
      updateCauldronContentDisplay();
      updateMaterialInventoryDisplay();
      playSound('sound-add-material');
      saveGameData();
    }

    function updateCauldronContentDisplay() {
      const div = document.getElementById('cauldron-content');
      div.innerHTML = '';
      if (cauldronContents.length === 0) {
        div.textContent = 'Malzeme se√ß...';
        return;
      }
      cauldronContents.forEach(item => {
        const emojiDiv = document.createElement('div');
        emojiDiv.textContent = materialData[item].emoji;
        div.appendChild(emojiDiv);
      });
    }
    
    function updateMaterialInventoryDisplay() {
        const container = document.getElementById('material-inventory-content');
        container.innerHTML = '';
        let hasMaterials = false;
        Object.entries(materialInventory).forEach(([material, count]) => {
            if (count > 0) {
                hasMaterials = true;
                const div = document.createElement('div');
                div.className = 'material-inv-item';
                div.textContent = `${materialData[material].emoji} ${material}: ${count}`;
                div.onclick = () => addToCauldron(material); 
                container.appendChild(div);
            }
        });
        if (!hasMaterials) {
            container.textContent = 'Malzeme yok. Yukarƒ±dan satƒ±n al.';
        }
    }

    function boilIngredients() {
      const potionData = createPotion(cauldronContents);
      if (potionData) {
        potionInventory[potionData.name] = (potionInventory[potionData.name] || 0) + 1;
        addXP(Math.floor(potionData.xp * xpGainMultiplier));
        
        totalPotionsMade++;
        checkAchievement('potionMaster', totalPotionsMade);
        
        if (!discoveredRecipes.has(potionData.name)) {
            discoveredRecipes.add(potionData.name);
            checkAchievement('tenRecipes', discoveredRecipes.size);
            if (discoveredRecipes.size === Object.keys(recipes).length) {
                 checkAchievement('allRecipes', discoveredRecipes.size);   
            }
        }
        
        cauldronContents = [];
        updateCauldronContentDisplay();
        updatePotionInventoryDisplay();
        playSound('sound-boil');
        checkAchievement('firstPotion');
      } else {
        showError(cauldronContents.length !== 2 && cauldronContents.length !== cauldronCapacity ? `Kazana tam olarak ${cauldronCapacity} malzeme eklemelisiniz!` : "Bu tarif i≈üe yaramaz!");
        cauldronContents = []; // Hatalƒ± denemede de kazan bo≈üalsƒ±n
        updateCauldronContentDisplay();
      }
      saveGameData();
    }

    function createPotion(ingredients) {
      if (ingredients.length !== 2 && (cauldronCapacity === 2 || ingredients.length !== cauldronCapacity) ) return null; 
      
      const sortedKey = [...ingredients].sort().join(',');
      return recipes[sortedKey] || null;
    }

    function updatePotionInventoryDisplay() {
      const container = document.getElementById('inventory-content');
      container.innerHTML = '';
      let hasPotions = false;
      Object.entries(potionInventory).forEach(([potion, count]) => {
        if (count > 0) {
          hasPotions = true;
          const div = document.createElement('div');
          div.className = 'inventory-item';
          div.textContent = `${potion}: ${count}`;
          container.appendChild(div);
        }
      });
      if (!hasPotions) {
          container.textContent = 'ƒ∞ksir yok.';
      }
    }

    function showError(message = "Bu tarif i≈üe yaramaz!") {
      const errorDiv = document.getElementById('error-message');
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
      playSound('sound-error');
      setTimeout(() => { errorDiv.style.display = 'none'; }, 3000);
    }

    function getRandomPotionName() {
      const i = Math.floor(Math.random() * availablePotions.length);
      return availablePotions[i];
    }

    function getRandomEmoji() {
      const i = Math.floor(Math.random() * availableEmojis.length);
      return availableEmojis[i];
    }

    function showCustomer(potionName) {
      const customerDiv = document.getElementById('customers');
      customerDiv.innerHTML = '';

      const cust = document.createElement('div');
      cust.classList.add('customer');
      const emoji = getRandomEmoji();
      
      const requestBubble = document.createElement('div');
      requestBubble.className = 'speech-bubble';
      requestBubble.textContent = `${potionName} l√ºtfen!`;
      cust.appendChild(requestBubble);

      const emojiContainer = document.createElement('div');
      emojiContainer.textContent = emoji;
      cust.appendChild(emojiContainer);


      if (Math.random() < 0.3 && stories[potionName]) {
        const story = stories[potionName][Math.floor(Math.random() * stories[potionName].length)];
        const storyBubble = document.createElement('div');
        storyBubble.className = 'speech-bubble story';
        storyBubble.textContent = story;
        cust.appendChild(storyBubble);
      }

      cust.onclick = () => sellPotion(potionName);
      customerDiv.appendChild(cust);

      currentCustomerPotion = potionName;
      playSound('sound-customer-appears');
    }

    function showNextCustomer() {
      currentCustomerPotion = getRandomPotionName(); // √ñnce yeni iksiri belirle
      showCustomer(currentCustomerPotion); // Sonra m√º≈üteriyi g√∂ster
      saveGameData(); // M√º≈üteri deƒüi≈ütiƒüinde kaydet
    }

    function sellPotion(potionName) {
      if (potionInventory[potionName] && potionInventory[potionName] > 0) {
        potionInventory[potionName]--;
        const salePrice = Math.floor((Object.values(recipes).find(r => r.name === potionName)?.price || 50) * potionSaleMultiplier);
        money += salePrice;
        addXP(10); 
        updatePotionInventoryDisplay();
        updateMoneyDisplay();
        
        currentCustomerPotion = null; // Satƒ±≈ütan sonra mevcut m√º≈üteri talebini temizle
        // saveGameData() burada zaten showNextCustomer i√ßinde √ßaƒürƒ±lacak
        playSound('sound-sell-potion');
        showNextCustomer(); // Yeni m√º≈üteri hemen gelsin
      } else {
        alert(`Maalesef, elimizde ${potionName} yok!`);
      }
    }
    
    function updateMoneyDisplay() {
        document.getElementById('money').textContent = `Para: ${money} TL`;
        if (document.getElementById('buy-modal-money')) {
             document.getElementById('buy-modal-money').textContent = money;
        }
        checkAchievement('richAlchemist', money);
    }

    function addXP(amount) {
        if(isNaN(amount)) return;
        xp += amount;
        if (xp >= xpToNextLevel) {
            level++;
            xp -= xpToNextLevel; // Kalan XP'yi bir sonraki seviyeye aktar
            xpToNextLevel = Math.floor(xpToNextLevel * 1.2); // Sonraki seviye i√ßin gereken XP'yi %20 artƒ±r
            playSound('sound-level-up');
            alert(`Tebrikler! Seviye ${level} oldunuz!`);
            renderUpgrades(); 
        }
        updateXPBar();
    }

    function updateXPBar() {
        document.getElementById('level-info').textContent = `Seviye: ${level}`;
        const progress = Math.min((xp / xpToNextLevel) * 100, 100); // %100'√º ge√ßmesin
        const xpBarElement = document.getElementById('xp-bar');
        xpBarElement.style.width = `${progress}%`;
        xpBarElement.textContent = `${Math.floor(xp)}/${xpToNextLevel} XP`;
    }

    function renderUpgrades() {
        const listDiv = document.getElementById('upgrades-list');
        listDiv.innerHTML = '';
        Object.entries(upgrades).forEach(([key, upgrade]) => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'upgrade-item';
            itemDiv.innerHTML = `
                <strong>${upgrade.name}</strong> (${upgrade.cost} TL): ${upgrade.description}
            `;
            const buyButton = document.createElement('button');
            buyButton.textContent = upgrade.purchased ? "Satƒ±n Alƒ±ndƒ±" : "Satƒ±n Al";
            buyButton.disabled = upgrade.purchased || money < upgrade.cost;
            buyButton.onclick = () => buyUpgrade(key);
            itemDiv.appendChild(buyButton);
            listDiv.appendChild(itemDiv);
        });
    }

    function buyUpgrade(upgradeKey) {
        const upgrade = upgrades[upgradeKey];
        if (!upgrade.purchased && money >= upgrade.cost) {
            money -= upgrade.cost;
            upgrade.purchased = true;
            if(typeof upgrade.effect === 'function') upgrade.effect(); // Efekti uygula
            playSound('sound-upgrade');
            updateMoneyDisplay();
            renderUpgrades(); // Buton durumunu g√ºncellemek i√ßin
            saveGameData();
        } else if (upgrade.purchased) {
            alert("Bu geli≈ütirmeyi zaten satƒ±n aldƒ±nƒ±z!");
        } else {
            alert("Yeterli paranƒ±z yok!");
        }
    }

    function renderAchievements() {
        const listDiv = document.getElementById('achievements-list');
        listDiv.innerHTML = '';
        Object.values(achievements).forEach(ach => {
            const itemDiv = document.createElement('div');
            itemDiv.className = `achievement-item ${ach.completed ? 'completed' : ''}`;
            itemDiv.innerHTML = `<strong>${ach.name}</strong>: ${ach.description}`;
            if (ach.completed && ach.reward && (ach.reward.money > 0 || ach.reward.xp > 0)) {
                itemDiv.innerHTML += `<br><span class="achievement-reward">√ñd√ºl: ${ach.reward.money}TL, ${ach.reward.xp}XP (Alƒ±ndƒ±)</span>`;
            } else if(ach.reward && (ach.reward.money > 0 || ach.reward.xp > 0)) {
                 itemDiv.innerHTML += `<br><span class="achievement-reward">√ñd√ºl: ${ach.reward.money}TL, ${ach.reward.xp}XP</span>`;
            }
            listDiv.appendChild(itemDiv);
        });
    }
    
    function checkAchievement(key, value) {
        const ach = achievements[key];
        if (ach && !ach.completed) {
            let conditionMet = false;
            if (key === 'firstPotion' && totalPotionsMade >= 1) conditionMet = true;
            else if (key === 'tenRecipes' && value >= 5) conditionMet = true; 
            else if (key === 'allRecipes' && value >= Object.keys(recipes).length) conditionMet = true;
            else if (key === 'richAlchemist' && value >= 1000) conditionMet = true;
            else if (key === 'potionMaster' && value >= 50) conditionMet = true;

            if (conditionMet) {
                ach.completed = true;
                if (ach.reward) {
                    if (ach.reward.money) money += ach.reward.money;
                    if (ach.reward.xp) addXP(ach.reward.xp);
                    updateMoneyDisplay();
                }
                playSound('sound-achievement');
                alert(`Ba≈üarƒ±m Kazanƒ±ldƒ±: ${ach.name}!`);
                renderAchievements(); // Ba≈üarƒ±m listesini g√ºncelle
                saveGameData();
            }
        }
    }
    
    function showModal(modalId) {
        if (modalId === 'upgrades-modal') renderUpgrades();
        if (modalId === 'achievements-modal') renderAchievements();
        document.getElementById(modalId).style.display = 'flex';
    }

    function closeModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
    }

    function loadGameData() {
      const savedMoney = localStorage.getItem('simyaMoney');
      const savedLevel = localStorage.getItem('simyaLevel');
      const savedXP = localStorage.getItem('simyaXP');
      const savedXPToNext = localStorage.getItem('simyaXPToNext');
      const savedPotionInv = localStorage.getItem('simyaPotionInventory');
      const savedMatInv = localStorage.getItem('simyaMaterialInventory');
      const savedCustomer = localStorage.getItem('simyaCurrentCustomerPotion');
      const savedUpgrades = localStorage.getItem('simyaUpgrades');
      const savedAchievements = localStorage.getItem('simyaAchievements');
      const savedDiscoveredRecipes = localStorage.getItem('simyaDiscoveredRecipes');
      const savedTotalPotionsMade = localStorage.getItem('simyaTotalPotionsMade');


      money = savedMoney ? parseInt(savedMoney) : 250;
      level = savedLevel ? parseInt(savedLevel) : 1;
      xp = savedXP ? parseInt(savedXP) : 0;
      xpToNextLevel = savedXPToNext ? parseInt(savedXPToNext) : 100;
      potionInventory = savedPotionInv ? JSON.parse(savedPotionInv) : {};
      materialInventory = savedMatInv ? JSON.parse(savedMatInv) : {};
      currentCustomerPotion = savedCustomer === "null" ? null : savedCustomer; // "null" string kontrol√º
      
      if (savedUpgrades) {
          const loadedUpgrades = JSON.parse(savedUpgrades);
          Object.keys(upgrades).forEach(key => {
              if (loadedUpgrades[key]) {
                  upgrades[key].purchased = loadedUpgrades[key].purchased;
                  if (upgrades[key].purchased && typeof upgrades[key].effect === 'function') upgrades[key].effect();
              }
          });
      }
       if (savedAchievements) {
          const loadedAchievements = JSON.parse(savedAchievements);
           Object.keys(achievements).forEach(key => {
              if (loadedAchievements[key]) {
                  achievements[key].completed = loadedAchievements[key].completed;
              }
          });
      }
      discoveredRecipes = savedDiscoveredRecipes ? new Set(JSON.parse(savedDiscoveredRecipes)) : new Set();
      totalPotionsMade = savedTotalPotionsMade ? parseInt(savedTotalPotionsMade) : 0;


      updateMoneyDisplay();
      updateXPBar();
      updatePotionInventoryDisplay();
      updateMaterialInventoryDisplay();
      renderUpgrades();
      renderAchievements();

      if (currentCustomerPotion) {
        showCustomer(currentCustomerPotion);
      } else {
        showNextCustomer();
      }
    }

    function saveGameData() {
      localStorage.setItem('simyaMoney', money);
      localStorage.setItem('simyaLevel', level);
      localStorage.setItem('simyaXP', xp);
      localStorage.setItem('simyaXPToNext', xpToNextLevel);
      localStorage.setItem('simyaPotionInventory', JSON.stringify(potionInventory));
      localStorage.setItem('simyaMaterialInventory', JSON.stringify(materialInventory));
      localStorage.setItem('simyaCurrentCustomerPotion', currentCustomerPotion);
      localStorage.setItem('simyaUpgrades', JSON.stringify(upgrades));
      localStorage.setItem('simyaAchievements', JSON.stringify(achievements));
      localStorage.setItem('simyaDiscoveredRecipes', JSON.stringify(Array.from(discoveredRecipes)));
      localStorage.setItem('simyaTotalPotionsMade', totalPotionsMade);
    }
    
    document.querySelectorAll('.material-item').forEach(item => {
        item.addEventListener('click', () => openBuyMaterialModal(item.dataset.name));
    });

    window.onload = loadGameData;
  </script>
</body>
</html>